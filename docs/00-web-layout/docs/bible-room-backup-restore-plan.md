# 성경자료실 데이터 백업 및 복구(restore) 계획서

## 1. 정책 및 전제

- 카테고리 ID는 사람이 읽을 수 있는 고정값(예: `genesis`, `exodus`, `old-testament`, `new-testament`)만 사용한다.
- 구약/신약은 각각 6x7, 6x5 그리드로 권별 배치한다.
- 모든 리소스(자료)는 category 필드에 사람이 읽을 수 있는 카테고리 id만 참조한다.

---

## 2. 데이터 구조 설계

### 2.1 카테고리 구조
- 구약/신약 그룹: `old-testament`, `new-testament`
- 각 권: `genesis`, `exodus`, ... (id와 name 매핑)

### 2.2 리소스 구조
```json
{
  "id": "...",
  "name": "창세기-아담의족보.html",
  "type": "html",
  "size": 15045,
  "category": "genesis", // 사람이 읽을 수 있는 id
  "uploadDate": 1749158445606,
  "chunks": [ ... ]
}
```

### 2.3 백업 파일 구조
- zip 파일 내부에 아래와 같이 저장
  - `bible-room/metadata.json` (카테고리/그리드/버전 정보)
  - `bible-room/resources/{categoryId}/{fileName}` (자료 파일)

---

## 3. 백업(Export) 프로세스

1. **메타데이터 구성**
   - 카테고리 id, name, order, parentId 등 전체 구조를 json으로 저장
   - 구약/신약 그리드 정보(6x7, 6x5) 포함
2. **리소스 데이터 수집**
   - 모든 리소스의 category가 사람이 읽을 수 있는 id인지 검증
   - 각 리소스를 해당 카테고리 폴더에 저장
3. **zip 파일 생성**
   - `metadata.json` + 자료 파일을 zip으로 묶음
4. **다운로드**
   - 파일명: `{YYYY-MM-DD}-bible-room-export.zip`

---

## 4. 복구(Import) 프로세스

1. **zip 파일 업로드 및 해제**
2. **메타데이터 검증**
   - 카테고리 id가 사람이 읽을 수 있는 값인지, 그리드 구조가 올바른지 확인
3. **기존 데이터 삭제(선택적)**
   - 기존 성경자료실 데이터 전체 삭제(옵션)
4. **카테고리 복원**
   - metadata.json의 카테고리 구조를 그대로 복원
   - id, name, order, parentId 모두 반영
5. **리소스 복원**
   - 각 자료의 category가 metadata.json의 카테고리 id와 일치하는지 검증 후 저장
   - 파일 데이터(Blob)도 함께 저장
6. **참조 무결성 검증**
   - 모든 리소스의 category가 실제 카테고리 테이블에 존재하는지 최종 검증
7. **UI/상태 동기화**
   - 복구 완료 후 UI 갱신 및 알림

---

## 5. 예외/에러 처리
- 카테고리 id가 사람이 읽을 수 없는 값이면 복구 중단 및 에러 메시지
- 리소스의 category가 카테고리 테이블에 없으면 해당 자료는 복구하지 않음(로그 기록)
- 메타데이터 구조 불일치, zip 파일 손상 등은 즉시 에러 처리

---

## 6. 실무적 권고 및 유지보수
- 내보내기/가져오기, 마이그레이션, 협업 등 모든 데이터 이동 시 사람이 읽을 수 있는 id 정책을 강제한다.
- 신규 카테고리 추가 시에도 id 네이밍 룰을 엄격히 적용한다.
- 장기적으로 데이터 무결성, 이식성, 유지보수성을 위해 정책 위반 데이터는 주기적으로 점검/정비한다.

---

## 7. 결론
- 사람이 읽을 수 있는 id 정책을 기반으로 한 백업/복구 로직은 참조 무결성, 이식성, 유지보수성, 협업 모든 면에서 가장 안전하다.
- zip+json 구조와 결합하면, 환경/DB/브라우저가 달라도 데이터 일관성을 완벽하게 보장할 수 있다. 

window.indexedDBService.migrateCategoryNames().then(() => alert('카테고리 name 복구완료!')); 