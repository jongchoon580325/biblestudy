# 하이브리드 데이터 저장 구조 및 동기화/상태 표시 PRD

## 1. 아키텍처 개요
- **온라인 저장소**: Supabase(PostgreSQL + Storage)
- **오프라인 저장소**: IndexedDB(주 데이터), LocalStorage(설정/임시)
- **동기화 엔진**: 네트워크 상태 기반 자동/수동 동기화, 충돌 감지/해결
- **자료실 구분**: 성경자료실, 일반자료실(공통 구조)

## 2. 데이터 저장/동기화 흐름
### 2.1 등록/수정/삭제
- **1차 저장**: IndexedDB(로컬) → 즉시 UI 반영, sync_status='pending'
- **동기화 큐 등록**: sync_queue에 작업 enqueue
- **백그라운드 동기화**: 네트워크 연결 시 Supabase로 push, 성공 시 sync_status='synced', 실패/충돌 시 'error'/'conflict'
- **삭제**: 로컬/서버 모두 soft delete, 동기화 큐 처리

### 2.2 조회
- **기본**: IndexedDB에서 즉시 조회(오프라인 우선)
- **최신화**: 동기화 성공 시 서버 데이터로 갱신

### 2.3 동기화 상태 관리
- **상태값**: 'synced', 'pending', 'syncing', 'conflict', 'error'
- **저장 위치**: 'local', 'server', 'both' (storage_location)
- **버전**: sync_version, updated_at 기반 충돌 감지

## 3. 상태 표시 UI/로직 설계
### 3.1 테이블 컬럼
- **상태 컬럼**: sync_status 뱃지(동기화됨/대기중/충돌/에러 등)
- **저장 위치**: storage_location(로컬/서버/양쪽)
- **마지막 동기화 시간**: last_sync

### 3.2 상태 뱃지/아이콘
- 색상/아이콘: 초록(동기화), 노랑(대기), 파랑(진행), 빨강(충돌), 회색(에러)
- Tooltip: 상세 상태/에러 메시지 제공

### 3.3 동기화/충돌 UI
- 수동 동기화 버튼, 충돌 해결 다이얼로그, 실시간 알림

## 4. 실전 구현 단계별 로드맵
1. **IndexedDB/LocalStorage 스키마 설계**: 자료, 큐, 설정 등
2. **자료 등록/수정/삭제 로컬 우선 구현**: useState→IndexedDB 연동
3. **동기화 큐/엔진 구현**: 네트워크 감지, 큐 polling, Supabase API 연동
4. **동기화 상태/저장 위치 계산 및 UI 표시**: 테이블/상세/미리보기 등
5. **충돌 감지/해결 로직 및 UI**: 버전/타임스탬프 기반, 수동/자동 병합
6. **알림/에러 처리**: 동기화 실패/충돌/복구 안내
7. **테스트/최적화**: 대용량, 오프라인, 충돌, 복원 시나리오

## 5. 성경자료실/일반자료실 테이블 연동 방안
- 공통 Material 타입 활용(local_id, sync_status, storage_location 등)
- 테이블/미리보기/상세/업로드 등 모든 화면에 상태 표시 일관 적용
- 상태별 필터/검색/통계 지원(예: 동기화 대기만 보기)

---
> 본 설계서는 실제 코드베이스와 PRD/TODO를 통합 분석하여, 하이브리드 저장/동기화/상태 표시의 실전 구현을 위한 기준 문서입니다. 